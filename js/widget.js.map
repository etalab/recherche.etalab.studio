{"version":3,"sources":["widget.js"],"names":["remoteUrl","datasetsUrl","dom","container","document","querySelector","Object","assign","search","categories","contribute","closeButton","injectCloseButton","cardsList","injectCardList","cardTemplate","searcher","LunrSearch","injectStylesheet","style","createElement","rel","href","head","appendChild","injectLunr","callback","lunrScript","loadLunrFr","lunrFrScript","src","onload","loadStemmer","lunrStemmerScript","button","classList","add","parentNode","insertBefore","addEventListener","disableWidget","div","listenFocus","enableWidget","listenSubmit","closest","event","stats","remove","listenSearch","text","target","value","updateInterface","listenCardsClick","Array","from","querySelectorAll","forEach","a","currentTarget","init","loadPopularDatasets","loadCards","populars","index","q","URLSearchParams","location","get","hackDom","id","__v_model","unbind","fetch","response","json","datasets","entries","i","dataset","logo_url","certified","certified_img","content","replace","_","match","trim","innerHTML","lastChild","updateCardsDisplay","ids","children","card","includes","params","set","qs","map","pair","join","window","history","pushState","matches","slice","m","ref","cleanupDiacritic","builder","pipelineFunction","token","update","normalizeText","String","lunr","Pipeline","registerFunction","pipeline","after","stemmer","searchPipeline","before","normalize","category","action","Piwik","getTracker","trackEvent","prototype","docs","_index","use","field","d","source","title","excerpt","split","reduce","acc","w","requirement","length","fuzziness","push"],"mappings":";AAgPC,SAAA,EAAA,EAAA,GAAA,OAAA,EAAA,IAAA,EAAA,EAAA,IAAA,EAAA,EAAA,IAAA,IAAA,SAAA,IAAA,MAAA,IAAA,UAAA,6IAAA,SAAA,EAAA,EAAA,GAAA,GAAA,oBAAA,QAAA,OAAA,YAAA,OAAA,GAAA,CAAA,IAAA,EAAA,GAAA,GAAA,EAAA,GAAA,EAAA,OAAA,EAAA,IAAA,IAAA,IAAA,EAAA,EAAA,EAAA,OAAA,cAAA,GAAA,EAAA,EAAA,QAAA,QAAA,EAAA,KAAA,EAAA,QAAA,GAAA,EAAA,SAAA,GAAA,GAAA,IAAA,MAAA,GAAA,GAAA,EAAA,EAAA,EAAA,QAAA,IAAA,GAAA,MAAA,EAAA,QAAA,EAAA,SAAA,QAAA,GAAA,EAAA,MAAA,GAAA,OAAA,GAAA,SAAA,EAAA,GAAA,GAAA,MAAA,QAAA,GAAA,OAAA,EAAA,SAAA,EAAA,GAAA,GAAA,oBAAA,QAAA,MAAA,EAAA,OAAA,UAAA,CAAA,GAAA,MAAA,QAAA,KAAA,EAAA,EAAA,IAAA,CAAA,IAAA,EAAA,EAAA,EAAA,aAAA,MAAA,CAAA,EAAA,EAAA,EAAA,WAAA,OAAA,GAAA,EAAA,OAAA,CAAA,MAAA,GAAA,CAAA,MAAA,EAAA,MAAA,EAAA,OAAA,EAAA,SAAA,GAAA,MAAA,GAAA,EAAA,GAAA,MAAA,IAAA,UAAA,yIAAA,IAAA,EAAA,EAAA,GAAA,EAAA,GAAA,EAAA,MAAA,CAAA,EAAA,WAAA,EAAA,EAAA,OAAA,aAAA,EAAA,WAAA,IAAA,EAAA,EAAA,OAAA,OAAA,EAAA,EAAA,KAAA,GAAA,EAAA,SAAA,GAAA,GAAA,EAAA,EAAA,GAAA,EAAA,WAAA,IAAA,GAAA,MAAA,EAAA,QAAA,EAAA,SAAA,QAAA,GAAA,EAAA,MAAA,KAAA,SAAA,EAAA,EAAA,GAAA,GAAA,EAAA,CAAA,GAAA,iBAAA,EAAA,OAAA,EAAA,EAAA,GAAA,IAAA,EAAA,OAAA,UAAA,SAAA,KAAA,GAAA,MAAA,GAAA,GAAA,MAAA,WAAA,GAAA,EAAA,cAAA,EAAA,EAAA,YAAA,MAAA,QAAA,GAAA,QAAA,EAAA,MAAA,KAAA,GAAA,cAAA,GAAA,2CAAA,KAAA,GAAA,EAAA,EAAA,QAAA,GAAA,SAAA,EAAA,EAAA,IAAA,MAAA,GAAA,EAAA,EAAA,UAAA,EAAA,EAAA,QAAA,IAAA,IAAA,EAAA,EAAA,EAAA,IAAA,MAAA,GAAA,EAAA,EAAA,IAAA,EAAA,GAAA,EAAA,GAAA,OAAA,EAAA,SAAA,EAAA,EAAA,EAAA,EAAA,EAAA,EAAA,EAAA,GAAA,IAAA,IAAA,EAAA,EAAA,GAAA,GAAA,EAAA,EAAA,MAAA,MAAA,GAAA,YAAA,EAAA,GAAA,EAAA,KAAA,EAAA,GAAA,QAAA,QAAA,GAAA,KAAA,EAAA,GAAA,SAAA,EAAA,GAAA,OAAA,WAAA,IAAA,EAAA,KAAA,EAAA,UAAA,OAAA,IAAA,QAAA,SAAA,EAAA,GAAA,IAAA,EAAA,EAAA,MAAA,EAAA,GAAA,SAAA,EAAA,GAAA,EAAA,EAAA,EAAA,EAAA,EAAA,EAAA,OAAA,GAAA,SAAA,EAAA,GAAA,EAAA,EAAA,EAAA,EAAA,EAAA,EAAA,QAAA,GAAA,OAAA,MA7OD,IAAMA,EAAN,4BACMC,EAAiBD,GAAAA,OAAAA,EAAvB,kBACME,EAAM,CAAEC,UAAWC,SAASC,cAAc,kCAChDC,OAAOC,OAAOL,EAAK,CACjBM,OAAQN,EAAIC,UAAUE,cAAc,iBACpCI,WAAYP,EAAIC,UAAUE,cAAc,8CACxCK,WAAYR,EAAIC,UAAUE,cAAc,qBAE1CC,OAAOC,OAAOL,EAAK,CAAES,YAAaC,IAAqBC,UAAWC,MAClE,IAAMC,EAAN,kXAaMC,EAAW,IAAIC,EAWrB,SAASC,IACDC,IAAAA,EAAQf,SAASgB,cAAc,QACrCD,EAAME,IAAM,aACZF,EAAMG,KAAUtB,GAAAA,OAAAA,EAAhB,mBACAI,SAASmB,KAAKC,YAAYL,GAG5B,SAASM,EAAWC,GAEZC,IAAAA,EAAavB,SAASgB,cAAc,UAUjCQ,SAAAA,IACDC,IAAAA,EAAezB,SAASgB,cAAc,UAC5CS,EAAaC,IAAS9B,GAAAA,OAAAA,EAAtB,kBACA6B,EAAaE,OAASL,EACtBtB,SAASmB,KAAKC,YAAYK,GAb5BF,EAAWG,IAAS9B,GAAAA,OAAAA,EAApB,eACA2B,EAAWI,OAEFC,WACDC,IAAAA,EAAoB7B,SAASgB,cAAc,UACjDa,EAAkBH,IAAS9B,GAAAA,OAAAA,EAA3B,+BACAiC,EAAkBF,OAASH,EAC3BxB,SAASmB,KAAKC,YAAYS,IAL5B7B,SAASmB,KAAKC,YAAYG,GAe5B,SAASf,IACDsB,IAAAA,EAAS9B,SAASgB,cAAc,UAI/Bc,OAHPA,EAAOC,UAAUC,IAAI,SACrBlC,EAAIO,WAAW4B,WAAWC,aAAaJ,EAAQhC,EAAIO,YACnDyB,EAAOK,iBAAiB,QAASC,GAC1BN,EAGT,SAASpB,IACD2B,IAAAA,EAAMrC,SAASgB,cAAc,OAG5BqB,OAFPA,EAAIN,UAAUC,IAAI,YAAa,uBAC/BlC,EAAIO,WAAW4B,WAAWC,aAAaG,EAAKvC,EAAIO,YACzCgC,EAGT,SAASC,IACPxC,EAAIM,OAAO+B,iBAAiB,QAASI,GAGvC,SAASC,IACP1C,EAAIM,OAAOqC,QAAQ,QAAQN,iBAAiB,SAAU,SAACO,GACrDC,EAAM,OAAQ,YAIlB,SAASJ,IACPzC,EAAIC,UAAUgC,UAAUC,IAAI,WAC5BlC,EAAIO,WAAW0B,UAAUC,IAAI,WAC7BlC,EAAIQ,WAAWyB,UAAUC,IAAI,WAC7BW,EAAM,SAAU,QAGlB,SAASP,IACPtC,EAAIC,UAAUgC,UAAUa,OAAO,WAC/B9C,EAAIO,WAAW0B,UAAUa,OAAO,WAChC9C,EAAIQ,WAAWyB,UAAUa,OAAO,WAChCD,EAAM,SAAU,SAGlB,SAASE,IACP/C,EAAIM,OAAO+B,iBAAiB,QAAS,WAC7BW,IAAAA,EAAOJ,MAAMK,OAAOC,MACvB5C,GAAOA,EAAO0C,GACjBG,EAAgBH,KAIpB,SAASI,IACPC,MAAMC,KAAKtD,EAAIW,UAAU4C,iBAAiB,WAAWC,QAAQ,SAAAC,GAC3DA,EAAEpB,iBAAiB,QAAS,SAAAO,GAC1BC,EAAM,QAASD,EAAMc,cAActC,UAK1BuC,SAAAA,IA0Hd,OAAA,EAAA,MAAA,KAAA,WAAA,SAAA,IAAA,OA1HD,EAAA,EAAA,mBAAA,KAAA,SAAA,IAAA,IAAA,EAAA,EAAA,OAAA,mBAAA,KAAA,SAAA,GAAA,OAAA,OAAA,EAAA,KAAA,EAAA,MAAA,KAAA,EACyBC,OADzB,EAAA,KAAA,EACyBA,IADzB,KAAA,EAEEC,EADMC,EADR,EAAA,MAGEV,IACAtC,EAASiD,MAAMD,GACTE,EAAI,IAAIC,gBAAgBC,SAAS5D,QAAQ6D,IAAI,KACnDtB,EAAM,SAAU,QACbmB,IACDhE,EAAIM,OAAO4C,MAAQc,EACnB1D,EAAO0D,GACPvB,KAVJ,KAAA,EAAA,IAAA,MAAA,OAAA,EAAA,SAAA,OA0HC,MAAA,KAAA,WA5GD,SAAS2B,IAEPpE,EAAIO,WAAW8D,GAAK,kBAEpBrE,EAAIC,UAAUE,cAAc,6BAA6B2C,SAEzD9C,EAAIM,OAAOgE,UAAUC,SAIRX,SAAAA,IAkGd,OAAA,EAAA,MAAA,KAAA,WAAA,SAAA,IAAA,OAlGD,EAAA,EAAA,mBAAA,KAAA,SAAA,IAAA,IAAA,EAAA,OAAA,mBAAA,KAAA,SAAA,GAAA,OAAA,OAAA,EAAA,KAAA,EAAA,MAAA,KAAA,EACyBY,OADzB,EAAA,KAAA,EACyBA,MAAMzE,GAD/B,KAAA,EAEe0E,OADPA,EADR,EAAA,KAAA,EAAA,KAAA,EAEeA,EAASC,OAFxB,KAAA,EAAA,OAAA,EAAA,OAAA,SAAA,EAAA,MAAA,KAAA,EAAA,IAAA,MAAA,OAAA,EAAA,SAAA,OAkGC,MAAA,KAAA,WA5FD,SAASb,EAAUc,GACUA,IADA,EACAA,EAAAA,EAAAA,EAASC,WADT,IAAA,IAAA,EAAA,WAAA,IAAA,EAAA,EAAA,EAAA,MAAA,GACfC,EADe,EAAA,GACZC,EADY,EAAA,GAErBA,EAAQC,WAAUD,EAAQC,SAAW,IACrCD,EAAQE,UACVF,EAAQG,cAAR,6IAKAH,EAAQG,cAAgB,GAEpBC,IAAAA,EAAUrE,EAAasE,QAC3B,oBACA,SAACC,EAAGC,GAAUP,OAAAA,EAAQO,EAAMC,UAE9BtF,EAAIW,UAAU4E,WAAaL,EAAQI,OAC/BT,GAAK,GACP7E,EAAIW,UAAU6E,UAAUvD,UAAUC,IAAI,WAhBK,IAAA,EAAA,MAAA,EAAA,EAAA,KAAA,MAAA,IADpB,MAAA,GAAA,EAAA,EAAA,GAAA,QAAA,EAAA,KAsB7B,SAASuD,EAAmBC,GAC1BrC,MAAMC,KAAKtD,EAAIW,UAAUgF,UAAUnC,QAAQ,SAAAoC,GACtCF,EAAIG,SAASD,EAAKvB,IAAKuB,EAAK3D,UAAUa,OAAO,UAC3C8C,EAAK3D,UAAUC,IAAI,YAI5B,SAASiB,EAAgBa,GACjB8B,IAAAA,EAAS,IAAI7B,gBAAgBC,SAAS5D,QAC5CwF,EAAOC,IAAI,IAAK/B,GACVgC,IAAAA,EAAK3C,MAAMC,KAAKwC,GAAQG,IAAI,SAAAC,GAAWA,MAAAA,GAAAA,OAAAA,EAAK,GAAMA,KAAAA,OAAAA,EAAK,MAAMC,KAAK,KACxEC,OAAOC,QAAQC,UAAU,GAAI,GAAQN,IAAAA,OAAAA,IAGvC,SAAS1F,EAAO0C,GACRuD,IAAAA,EAAUzF,EAASR,OAAO0C,GAChCH,EAAM,SAAUG,GAChByC,EAAmBc,EAAQC,MAAM,EAAG,IAAIP,IAAI,SAAAQ,GAAKA,OAAAA,EAAEC,OAGrD,SAAS3F,KAET,SAAS4F,EAAiBC,GACfC,SAAAA,EAAiBC,GACjBA,OAAAA,EAAMC,OAAO,WAAMC,OAAAA,EAAcC,OAAOH,MAEjDI,KAAKC,SAASC,iBAAiBP,EAAkB,oBACjDD,EAAQS,SAASC,MAAMJ,KAAKK,QAASV,GACrCD,EAAQY,eAAeC,OAAOP,KAAKK,QAASV,GAsB9C,SAASG,EAAchE,GACdA,OAAAA,GAAQA,EAAK0E,UAAU,OAAOvC,QAAQ,mBAAoB,IAenE,SAAStC,EAAM8E,EAAUC,GACH,oBAAVC,OACAA,MAAMC,aACdC,WAAwBJ,aAAAA,OAAAA,GAAYC,GApNxCxD,IACApD,IACAwB,IACAE,IACAnB,EAAW,WACToC,IACAZ,MAwKFhC,EAAWiH,UAAUjE,MAAQ,SAASkE,GAC/BC,KAAAA,OAAShB,KAAK,WAAY,IAAA,EAAA,KACxBiB,KAAAA,IAAIxB,GACJD,KAAAA,IAAI,MACJ0B,KAAAA,MAAM,WACNA,KAAAA,MAAM,SACNA,KAAAA,MAAM,WACNA,KAAAA,MAAM,UACXH,EAAKzE,QAAQ,SAAA6E,GAELA,EAAEhE,GACI,CAACgE,EAAEC,OAAQD,EAAEE,MAAOF,EAAEC,OAAQD,EAAEG,SAASrC,KAAK,KAE1D,EAAKjE,IAAImG,QAUftH,EAAWiH,UAAU1H,OAAS,SAAS0C,GAS9B,OARPA,EAAOA,EAAKyF,MAAM,QAAQC,OAAO,SAACC,EAAKC,GAC/BC,IAAAA,EAAcD,EAAEE,OAAS,EAAI,IAAM,GACrCC,EAAY,GAITJ,OAHJC,EAAEE,QAAU,GAAKH,EAAIG,OAAS,EAAGC,EAAY,IACxCH,EAAEE,OAAS,IAAGC,EAAY,MAC/BH,GAAGD,EAAIK,KAAQH,GAAAA,OAAAA,GAAcD,OAAAA,GAAIG,OAAAA,IAC7BJ,GACN,IAAIxC,KAAK,KACL,KAAK+B,OAAO5H,OAAO0C","file":"widget.js","sourceRoot":"src","sourcesContent":["/**\n * Declarations\n */\nconst remoteUrl = `//recherche.etalab.studio`\nconst datasetsUrl = `${remoteUrl}/datasets.json`\nconst dom = { container: document.querySelector('.navbar-static-top .container') }\nObject.assign(dom, {\n  search: dom.container.querySelector('[type=search]'),\n  categories: dom.container.querySelector('nav.sidebar.panel.collapse.subnav-collapse'),\n  contribute: dom.container.querySelector('.call-to-action'),\n})\nObject.assign(dom, { closeButton: injectCloseButton(), cardsList: injectCardList() })\nconst cardTemplate = `<div class=\"col-xs-12 col-md-4 col-sm-6\" id=\"{{ id }}\">\n<a class=\"card dataset-card\" href=\"{{ page }}\">\n  <div class=\"card-logo\">\n    <img alt=\"{{ title }}\"\n      src=\"{{ logo_url }}\" width=\"70\" height=\"70\">\n  </div>\n  {{ certified_img }}\n  <div class=\"card-body\">\n    <h4>{{ title }}</h4>\n    <div class=\"clamp-3\">{{ excerpt }}</div>\n  </div>\n</a>\n</div>`\nconst searcher = new LunrSearch()\n\nhackDom()\ninjectStylesheet()\nlistenFocus()\nlistenSubmit()\ninjectLunr(() => {\n  init()\n  listenSearch()\n})\n\nfunction injectStylesheet() {\n  const style = document.createElement('link')\n  style.rel = 'stylesheet'\n  style.href = `${remoteUrl}/css/widget.css`\n  document.head.appendChild(style)\n}\n\nfunction injectLunr(callback) {\n  // Lunr injection must be performed step by step.\n  const lunrScript = document.createElement('script')\n  lunrScript.src = `${remoteUrl}/js/lunr.js`\n  lunrScript.onload = loadStemmer\n  document.head.appendChild(lunrScript)\n  function loadStemmer() {\n    const lunrStemmerScript = document.createElement('script')\n    lunrStemmerScript.src = `${remoteUrl}/js/lunr.stemmer.support.js`\n    lunrStemmerScript.onload = loadLunrFr\n    document.head.appendChild(lunrStemmerScript)\n  }\n  function loadLunrFr() {\n    const lunrFrScript = document.createElement('script')\n    lunrFrScript.src = `${remoteUrl}/js/lunr.fr.js`\n    lunrFrScript.onload = callback\n    document.head.appendChild(lunrFrScript)\n  }\n}\n\nfunction injectCloseButton() {\n  const button = document.createElement('button')\n  button.classList.add('close')\n  dom.categories.parentNode.insertBefore(button, dom.categories)\n  button.addEventListener('click', disableWidget)\n  return button\n}\n\nfunction injectCardList() {\n  const div = document.createElement('div')\n  div.classList.add('card-list', 'card-list--columned')\n  dom.categories.parentNode.insertBefore(div, dom.categories)\n  return div\n}\n\nfunction listenFocus() {\n  dom.search.addEventListener('focus', enableWidget)\n}\n\nfunction listenSubmit() {\n  dom.search.closest('form').addEventListener('submit', (event) => {\n    stats('form', 'submit')\n  })\n}\n\nfunction enableWidget() {\n  dom.container.classList.add('focused')\n  dom.categories.classList.add('fadeout')\n  dom.contribute.classList.add('fadeout')\n  stats('widget', 'open')\n}\n\nfunction disableWidget() {\n  dom.container.classList.remove('focused')\n  dom.categories.classList.remove('fadeout')\n  dom.contribute.classList.remove('fadeout')\n  stats('widget', 'close')\n}\n\nfunction listenSearch() {\n  dom.search.addEventListener('keyup', () => {\n    const text = event.target.value\n    if(search)search(text)\n    updateInterface(text)\n  })\n}\n\nfunction listenCardsClick() {\n  Array.from(dom.cardsList.querySelectorAll('a.card')).forEach(a => {\n    a.addEventListener('click', event => {\n      stats('click', event.currentTarget.href)\n    })\n  })\n}\n\nasync function init() {\n  const populars = await loadPopularDatasets()\n  loadCards(populars)\n  listenCardsClick()\n  searcher.index(populars)\n  const q = new URLSearchParams(location.search).get('q')\n  stats('widget', 'load')\n  if(q) {\n    dom.search.value = q\n    search(q)\n    enableWidget()\n  }\n}\n\nfunction hackDom() {\n  // Some CSS in non-overridable due to `!important` which heavy selectors\n  dom.categories.id = 'categories-node'\n  // Deactivate the suggestion dropdown\n  dom.container.querySelector('.dropdown-menu.suggestion').remove()\n  // Unsassign Vue\n  dom.search.__v_model.unbind()\n}\n\n\nasync function loadPopularDatasets() {\n  const response = await fetch(datasetsUrl)\n  return await response.json()\n}\n\n\nfunction loadCards(datasets) {\n  for (const [i, dataset] of datasets.entries()) {\n    if(!dataset.logo_url) dataset.logo_url = ''\n    if (dataset.certified) {\n      dataset.certified_img = `<img\n        src=\"https://static.data.gouv.fr/_themes/gouvfr/img/certified-stamp.png\"\n        alt=\"certified\" class=\"certified\"\n      >`\n    } else {\n      dataset.certified_img = ''\n    }\n    const content = cardTemplate.replace(\n      /\\{\\{\\s*(.*)\\s*}}/g,\n      (_, match) => dataset[match.trim()]\n    )\n    dom.cardsList.innerHTML += content.trim()\n    if (i >= 6) {\n      dom.cardsList.lastChild.classList.add('hidden')\n    }\n  }\n}\n\nfunction updateCardsDisplay(ids) {\n  Array.from(dom.cardsList.children).forEach(card => {\n    if(ids.includes(card.id)) card.classList.remove('hidden')\n    else card.classList.add('hidden')\n  })\n}\n\nfunction updateInterface(q) {\n  const params = new URLSearchParams(location.search)\n  params.set('q', q)\n  const qs = Array.from(params).map(pair => `${pair[0]}=${pair[1]}`).join('&')\n  window.history.pushState({}, '', `?${qs}`)\n}\n\nfunction search(text) {\n  const matches = searcher.search(text)\n  stats('search', text)\n  updateCardsDisplay(matches.slice(0, 12).map(m => m.ref))\n}\n\nfunction LunrSearch() {}\n\nfunction cleanupDiacritic(builder) {\n  function pipelineFunction(token) {\n    return token.update(() => normalizeText(String(token)))\n  }\n  lunr.Pipeline.registerFunction(pipelineFunction, 'cleanupDiacritic')\n  builder.pipeline.after(lunr.stemmer, pipelineFunction)\n  builder.searchPipeline.before(lunr.stemmer, pipelineFunction)\n}\n\nLunrSearch.prototype.index = function(docs) {\n  this._index = lunr(function () {\n    this.use(cleanupDiacritic)\n    this.ref('id')\n    this.field('acronym')\n    this.field('title')\n    this.field('excerpt')\n    this.field('source')\n    docs.forEach(d => {\n      const tmp = {\n        id: d.id,\n        keywords: [d.source, d.title, d.source, d.excerpt].join(' ')\n      }\n      this.add(d)\n    })\n\n  })\n}\n\nfunction normalizeText(text) {\n  return text && text.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\n}\n\nLunrSearch.prototype.search = function(text) {\n  text = text.split(/\\s+/g).reduce((acc, w) => {\n    const requirement = w.length > 3 ? '+' : ''\n    let fuzziness = ''\n    if(w.length <= 4 && acc.length > 0) fuzziness = '*'\n    else if(w.length > 4) fuzziness = '~2'\n    if(w) acc.push(`${requirement}${w}${fuzziness}`)\n    return acc\n  }, []).join(' ')\n  return this._index.search(text)\n}\n\nfunction stats(category, action) {\n  if(typeof Piwik === 'undefined') return\n  const t = Piwik.getTracker()\n  t.trackEvent(`Recherche/${category}`, action)\n}\n"]}